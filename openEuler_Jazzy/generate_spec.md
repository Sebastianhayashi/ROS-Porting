# 生成 spec

## 伪装

由于目前的 openeuler 并不是 ROS 的官方工具链支持的发行版，参考官方文档以下内容：

> **ROS_OS_OVERRIDE**
> 
> 
> Format: "OS_NAME:OS_VERSION_STRING:OS_CODENAME" This will force it to detect Ubuntu Bionic:
> 
> ```
> export ROS_OS_OVERRIDE=ubuntu:18.04:bionic
> ```
> 
> If defined, this will override the autodetection of an OS. This can be useful when debugging rosdep dependencies on alien platforms, when platforms are actually very similar and might need be forced, or of course if the autodetection is failing.
> 

可以采用 `export ROS_OS_OVERRIDE=` 指定变量的方式，将 openeuler 伪装成 rhel9：

```
export ROS_OS_OVERRIDE=rhel:9
```

或者也可以在使用 rosdep 的时候单独使用参数指定，如：

```
# rosdep 检查 src 下所有需要的系统依赖
rosdep check --from-paths src --ignore-src --os=rhel:9
```

由于目前 openeuler 24.03 LTS 上存在一些与 rhel9 命名不同的软件包，以下是发现差异的软件包列表，也正是因为这些差异所以导致了依赖的缺失：

```
dnf    python%{python3_pkgversion}-pygraphviz
dnf    opencv-devel
dnf    python3-flake8-builtins
dnf    python3-flake8-comprehensions
dnf    python3-flake8-quotes
dnf    python3-vcstool
```

上面每一个包的详细情况请见附录。

在使用 bloom 生成 spec 的时候可以参考：

```
bloom-generate rosrpm --ros-distro jazzy --os-name rhel --os-version 9
```

## bloom 生成 spec

使用 bloom 工具会在源码文件夹下生成一个名为 rpm 的文件夹：

```
➜  ament_package git:(Multi-Version_ros-jazzy_openEuler-24.03-LTS) ✗ ls
ament_package  CHANGELOG.rst  CONTRIBUTING.md  LICENSE  package.xml  pytest.ini  resource  rpm  setup.py  test
➜  ament_package git:(Multi-Version_ros-jazzy_openEuler-24.03-LTS) ✗ ls rpm
template.spec
```

其中 `template.spec` 是按照 bloom 工具内置的默认模版生成的，下面以 ament_packages 为例：

```
➜  rpm git:(Multi-Version_ros-jazzy_openEuler-24.03-LTS) ✗ cat template.spec
%bcond_without tests
%bcond_without weak_deps

%global __os_install_post %(echo '%{__os_install_post}' | sed -e 's!/usr/lib[^[:space:]]*/brp-python-bytecompile[[:space:]].*$!!g')
%global __provides_exclude_from ^/usr/.*$
%global __requires_exclude_from ^/usr/.*$

Name:           ros-jazzy-ament-package
Version:        0.16.4
Release:        0%{?dist}%{?release_suffix}
Summary:        ROS ament_package package

License:        Apache License 2.0
Source0:        %{name}-%{version}.tar.gz

Requires:       python%{python3_pkgversion}-setuptools
Requires:       python3
BuildRequires:  python%{python3_pkgversion}-devel

%if 0%{?with_tests}
BuildRequires:  python%{python3_pkgversion}-flake8
BuildRequires:  python%{python3_pkgversion}-pytest
%endif

%description
The parser for the manifest files in the ament buildsystem.

%prep
%autosetup -p1

%build
# In case we're installing to a non-standard location, look for a setup.sh
# in the install tree and source it.  It will set things like
# CMAKE_PREFIX_PATH, PKG_CONFIG_PATH, and PYTHONPATH.
if [ -f "/usr/setup.sh" ]; then . "/usr/setup.sh"; fi
%py3_build

%install
# In case we're installing to a non-standard location, look for a setup.sh
# in the install tree and source it.  It will set things like
# CMAKE_PREFIX_PATH, PKG_CONFIG_PATH, and PYTHONPATH.
if [ -f "/usr/setup.sh" ]; then . "/usr/setup.sh"; fi
%py3_install -- --prefix "/usr"

%if 0%{?with_tests}
%check
# Look for a directory with a name indicating that it contains tests
TEST_TARGET=$(ls -d * | grep -m1 "\(test\|tests\)" ||:)
if [ -n "$TEST_TARGET" ] && %__python3 -m pytest --version; then
# In case we're installing to a non-standard location, look for a setup.sh
# in the install tree and source it.  It will set things like
# CMAKE_PREFIX_PATH, PKG_CONFIG_PATH, and PYTHONPATH.
if [ -f "/usr/setup.sh" ]; then . "/usr/setup.sh"; fi
%__python3 -m pytest $TEST_TARGET || echo "RPM TESTS FAILED"
else echo "RPM TESTS SKIPPED"; fi
%endif

%files
/usr

%changelog
* Mon Sep 22 2025 Dharini Dutia <dharini@openrobotics.org> - 0.16.4-0
- Autogenerated by Bloom
```

## 规范化

1. 发行版版本变量化

根据 openeuler-src 仓库下的 spec [文件](https://gitee.com/src-openeuler/ament_cmake/raw/humble/ament-cmake-python.spec)来看，统一安装的前缀为：`/opt/ros/%{ros_distro}`。

默认的模版生成出来的 spec 是直接指定了版本，如 jazzy。

2. 安装路径

模版的默认路径是安装进去了：

```
%files
/usr
```

同样根据 openeuler-src 下的 spec 文件来看（同上），安装路径需要为：

```
/opt/ros/%{ros_distro}
```

3. spec 改名并提取

在生成的 rpm 文件夹下的 spec 文件默认都是 template.spec，需要修改成软件包同名，否则 eulermaker 等构建工具会不认。

## 自动化方案

bloom 工具仅支持一次生成一个软件包的 spec 文件，面对成百上千的源码包，我们需要使用一些自动化的脚本来辅助批量化的生成。

~~自动化方案分为两个阶段，第一个是生成 spec，第二个是给 spec 文件进行规范化。~~

## 附录

软件包情况

> 说明：查看日期为：22/09/25，同时每查看一次也已经执行了 sudo dnf update。

1. dnf    python%{python3_pkgversion}-pygraphviz

```
➜  ~ dnf search graphviz
Last metadata expiration check: 0:00:12 ago on Mon 22 Sep 2025 14:18:16.
===================================================================== Name Exactly Matched: graphviz ======================================================================
graphviz.x86_64 : Graph Visualization Tools
graphviz.src : Graph Visualization Tools
==================================================================== Name & Summary Matched: graphviz =====================================================================
graphviz-debuginfo.x86_64 : Debug information for package graphviz
graphviz-debugsource.x86_64 : Debug sources for package graphviz
graphviz-devel.x86_64 : Development headers and libraries for interfacing to the graphviz
graphviz-docs.x86_64 : Documentation files for graphviz
graphviz-gd.x86_64 : Graphviz plugin for renderers based on gd
graphviz-graphs.x86_64 : Demo graphs for graphviz
graphviz-guile.x86_64 : Guile extension for graphviz
graphviz-java.x86_64 : Java extension for graphviz
graphviz-lua.x86_64 : Lua extension for graphviz
graphviz-ocaml.x86_64 : Ocaml extension for graphviz
graphviz-perl.x86_64 : Perl extension for graphviz
graphviz-python3.x86_64 : Python 3 extension for graphviz
graphviz-ruby.x86_64 : Ruby extension for graphviz
graphviz-tcl.x86_64 : Tcl extension & tools for graphviz
python-graphviz-help.noarch : Development documents and examples for graphviz
python3-graphviz.noarch : Simple Python interface for Graphviz
texlive-graphviz.noarch : Write graphviz (dot+neato) inline in LaTeX documents
texlive-graphviz-doc.noarch : Documentation for graphviz
======================================================================== Summary Matched: graphviz ========================================================================
python-pydot.src : Python interface to Graphviz's Dot
python-pydot-help.noarch : Python interface to Graphviz's Dot
python3-pydot.noarch : Python interface to Graphviz's Dot
python3-pydotplus.noarch : Python interface to Graphviz's Dot language
```
2. dnf    opencv-devel

```
➜  ~ dnf search opencv
Last metadata expiration check: 0:00:45 ago on Mon 22 Sep 2025 14:18:16.
===================================================================== Name & Summary Matched: opencv ======================================================================
opencv.x86_64 : OpenCV means Intel® Open Source Computer Vision Library.
```

3. dnf    python3-flake8-builtins

```
➜  ~ dnf search flake8
Last metadata expiration check: 0:01:09 ago on Mon 22 Sep 2025 14:18:16.
===================================================================== Name & Summary Matched: flake8 ======================================================================
flake8-virtual.noarch : Virtual package to satisfy flake8 dependencies
python-flake8-docstrings-help.noarch : Extension for flake8 which uses pep257 to check docstrings
python-flake8-help.noarch : Development documents and examples for flake8
python-flake8-import-order-help.noarch : Flake8 and pylama plugin that checks the ordering of import statements.
python-flake8-logging-format-help.noarch : Flake8 extension to validate (lack of) logging format strings
python3-flake8-docstrings.noarch : Extension for flake8 which uses pep257 to check docstrings
python3-flake8-import-order.noarch : Flake8 and pylama plugin that checks the ordering of import statements.
python3-flake8-logging-format.noarch : Flake8 extension to validate (lack of) logging format strings
ros-jazzy-ament-cmake-flake8.x86_64 : ROS ament_cmake_flake8 package
ros-jazzy-ament-flake8.x86_64 : ROS ament_flake8 package
========================================================================== Name Matched: flake8 ===========================================================================
python-flake8.src : the modular source code checker: pep8 pyflakes and co
python3-flake8.noarch : the modular source code checker: pep8 pyflakes and co
```

4. dnf    python3-flake8-comprehensions

同 3

5. dnf    python3-flake8-quotes

同3

6. dnf    python3-vcstool

```
➜  ~ dnf search vcstool
Last metadata expiration check: 0:01:52 ago on Mon 22 Sep 2025 14:18:16.
====================================================================== Name Exactly Matched: vcstool ======================================================================
vcstool.noarch : A command-line tool to manage multiple repositories
➜  ~
```